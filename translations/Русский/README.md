# samp-query-node

Полное API для среды **Node.js**, разработанное для запросов к серверам SA-MP (San Andreas Multiplayer) и совместимое с OPEN.MP (Open Multiplayer). Предлагает расширенные возможности мониторинга и сбора информации в реальном времени.

### Языки

- Português: [README](../../)
- Deutsch: [README](../Deutsch/README.md)
- English: [README](../English/README.md)
- Español: [README](../Espanol/README.md)
- Français: [README](../Francais/README.md)
- Italiano: [README](../Italiano/README.md)
- Polski: [README](../Polski/README.md)
- Svenska: [README](../Svenska/README.md)
- Türkçe: [README](../Turkce/README.md)

## Содержание

- [samp-query-node](#samp-query-node)
    - [Языки](#языки)
  - [Содержание](#содержание)
  - [Об API](#об-api)
  - [Установка](#установка)
  - [Функциональность](#функциональность)
    - [Основная система запросов](#основная-система-запросов)
  - [Структура API](#структура-api)
    - [Основные классы](#основные-классы)
      - [1. DNS\_Cache](#1-dns_cache)
      - [2. Query\_Manager](#2-query_manager)
      - [3. SAMP\_Strings](#3-samp_strings)
  - [Система кэширования DNS](#система-кэширования-dns)
  - [Система задержки](#система-задержки)
    - [Измерение пинга](#измерение-пинга)
    - [Примеры использования](#примеры-использования)
      - [1. Базовый запрос](#1-базовый-запрос)
      - [2. Запрос с пользовательскими настройками](#2-запрос-с-пользовательскими-настройками)
      - [3. Использование Promises](#3-использование-promises)
      - [4. Непрерывный мониторинг](#4-непрерывный-мониторинг)
  - [Обработка ошибок](#обработка-ошибок)
    - [1. Ошибки подключения](#1-ошибки-подключения)
    - [2. Таймауты](#2-таймауты)
    - [3. Проверка данных](#3-проверка-данных)
  - [Соображения производительности](#соображения-производительности)
    - [Реализованные оптимизации](#реализованные-оптимизации)
  - [Технические ограничения](#технические-ограничения)
  - [Структура ответа](#структура-ответа)
  - [Лицензия](#лицензия)
    - [Условия:](#условия)

## Об API

**SA-MP Query Node** - это API, специально разработанное для взаимодействия с серверами SA-MP, позволяющее собирать подробную информацию о сервере в реальном времени. API использует нативный протокол запросов SA-MP и реализует несколько уровней оптимизации для обеспечения эффективных и надежных запросов.

API разработано с упором на:
- Надежность запросов
- Эффективность обработки
- Простоту использования
- Надежную обработку ошибок
- Полную поддержку всех функций протокола SA-MP

## Установка

Клонируйте репозиторий на локальную машину:

```bash
git clone https://github.com/ocalasans/samp-query-node.git
```

## Функциональность

### Основная система запросов

API предоставляет полную систему запросов, которая позволяет получить:

1. **Базовая информация о сервере:**
   - Название сервера
   - Текущий режим игры
   - Настроенный язык
   - Статус защиты паролем
   - Максимальное количество игроков
   - Текущее количество онлайн-игроков

2. **Подробный список игроков:**
   - ID игрока
   - Имя игрока
   - Текущий счет
   - Задержка (пинг) игрока

3. **Правила сервера:**
   - Настройки компенсации лага
   - Текущая погода
   - Другие пользовательские правила, установленные сервером

4. **Измерения производительности:**
   - Задержка сервера (пинг)
   - Время ответа на запросы
   - Статистика подключения

## Структура API

### Основные классы

#### 1. DNS_Cache
```javascript
class DNS_Cache {
    constructor() {
        this.cache = new Map();
        this.Resolve_DNS = promisify(dns.resolve4);
    }
}
```

Класс **DNS_Cache** отвечает за:
- Временное хранение разрешений DNS
- Оптимизацию повторных запросов
- Уменьшение задержки подключения
- Управление временем жизни кэша

Основные методы:
- `Get_IP_Address(host_name)`: Разрешает и кэширует IP-адреса
- Автоматическое кэширование с настраиваемой продолжительностью (по умолчанию: 5 минут)
- Возврат к имени хоста в случае сбоя разрешения

#### 2. Query_Manager
```javascript
class Query_Manager extends EventEmitter {
    constructor() {
        super();
        this.Active_Queries = new Map();
    }
}
```

**Query_Manager** контролирует:
- Управление активными запросами
- Таймауты и повторные попытки
- События завершения запроса
- Очистку устаревших запросов

Функциональность:
- Система автоматического повтора
- Контроль времени ожидания
- Управление множественными одновременными запросами
- Генерация событий завершения

#### 3. SAMP_Strings
```javascript
class SAMP_Strings {
    static charset = [/* набор символов SA-MP */];
    static Decode_String(buffer_data) { /* ... */ }
}
```

Отвечает за:
- Декодирование строк SA-MP
- Поддержку специальных символов
- Очистку и санитизацию строк
- Преобразование буферов в текст

## Система кэширования DNS

Система кэширования DNS является crucial частью API, реализующей:

1. **Управление кэшем:**
   - Эффективное хранение разрешений DNS
   - Проверка временной действительности
   - Автоматическая очистка старых записей

2. **Оптимизация производительности:**
   - Уменьшение избыточных DNS-запросов
   - Улучшение времени отклика
   - Экономия сетевых ресурсов

3. **Настройки кэша:**
   ```javascript
   const DNS_CACHE_TIME = 300000; // 5 минут
   ```

4. **Обработка сбоев:**
   - Возврат к исходному имени хоста
   - Автоматический повтор при временных сбоях
   - Логирование ошибок разрешения

## Система задержки

### Измерение пинга

Система измерения задержки реализует:

1. **Сбор образцов:**
   ```javascript
   const LATENCY = {
       SAMPLES: 5,
       CHECK_INTERVAL: 50,
       TIMEOUT: 2000,
       MAX_VALID_PING: 800
   };
   ```

2. **Обработка результатов:**
   - Расчет средней задержки
   - Фильтрация выбросов
   - Обнаружение таймаутов

3. **Оптимизации:**
   - Множественные образцы для точности
   - Настраиваемые интервалы
   - Независимые таймауты

### Примеры использования

#### 1. Базовый запрос
```javascript
const query = require('samp-query-node');

query('127.0.0.1:7777', (ошибка, ответ) => {
    if (ошибка) {
        console.error('Ошибка запроса:', ошибка);
        return;
    }
    
    console.log('Информация о сервере:', ответ);
});
```

#### 2. Запрос с пользовательскими настройками
```javascript
const опции = {
    host: '127.0.0.1',
    port: 7777,
    timeout: 1500  // таймаут 1.5 секунды
};

query(опции, (ошибка, ответ) => {
    if (ошибка) {
        console.error('Ошибка:', ошибка);
        return;
    }
    
    console.log('Название сервера:', ответ.hostname);
    console.log('Игроки:', ответ.onlinePlayers);
    console.log('Режим игры:', ответ.gamemode);
    
    // Обработка списка игроков
    ответ.players.forEach(игрок => {
        console.log(`${игрок.name}: ${игрок.score} очков`);
    });
});
```

#### 3. Использование Promises
```javascript
const util = require('util');
const Query_Async = util.promisify(query);

async function Запросить_Сервер() {
    try {
        const инфо = await Query_Async('127.0.0.1:7777');
        
        console.log('Сервер:', инфо.hostname);
        console.log('Игроки:', инфо.onlinePlayers);
        console.log('Пинг:', инфо.ping, 'мс');
        
        // Обработка правил сервера
        if (инфо.rules.lagcomp === 'On') {
            console.log('Сервер с включенной компенсацией лага');
        }
        
        // Список топ игроков
        const топИгроки = инфо.players
            .sort((a, b) => b.score - a.score)
            .slice(0, 5);
            
        console.log('\nТоп 5 игроков:');
        топИгроки.forEach((игрок, индекс) => {
            console.log(`${индекс + 1}. ${игрок.name}: ${игрок.score} очков`);
        });
        
    } catch (ошибка) {
        console.error('Ошибка при запросе сервера:', ошибка);
    }
}
```

#### 4. Непрерывный мониторинг
```javascript
async function Мониторинг_Сервера(адрес, интервал = 60000) {
    const Query_Async = util.promisify(query);
    
    console.log(`Запуск мониторинга ${адрес}`);
    
    setInterval(async () => {
        try {
            const инфо = await Query_Async(адрес);
            
            console.log('\n=== Статус сервера ===');
            console.log(`Время: ${new Date().toLocaleString()}`);
            console.log(`Игроки: ${инфо.onlinePlayers}/${инфо.maxPlayers}`);
            console.log(`Пинг: ${инфо.ping}мс`);
            console.log(`Режим: ${инфо.gamemode}`);
            
            if (инфо.onlinePlayers > 0) {
                console.log('\nИгроки онлайн:');
                инфо.players.forEach(игрок => {
                    console.log(`- ${игрок.name} (Пинг: ${игрок.ping}мс)`);
                });
            }
            
        } catch (ошибка) {
            console.error('Ошибка мониторинга:', ошибка);
        }
    }, интервал);
}
```

## Обработка ошибок

API реализует надежную систему обработки ошибок:

### 1. Ошибки подключения
```javascript
query('127.0.0.1:7777', (ошибка, ответ) => {
    if (!ответ.hostname) {
        console.log('Сервер офлайн или недоступен');
    }
});
```

### 2. Таймауты
```javascript
const опции = {
    host: '127.0.0.1',
    port: 7777,
    timeout: 2000  // 2 секунды
};

query(опции, (ошибка, ответ) => {
    if (ошибка) {
        console.log('Сервер не ответил в установленное время');
    }
});
```

### 3. Проверка данных
```javascript
query('127.0.0.1:7777', (ошибка, ответ) => {
    // Проверки безопасности
    if (ответ.onlinePlayers > ответ.maxPlayers) {
        console.log('Получены несогласованные данные');
        return;
    }
    
    // Валидация игроков
    ответ.players = ответ.players.filter(игрок => {
        return игрок.name && игрок.score >= 0 && игрок.ping >= 0;
    });
});
```

## Соображения производительности

### Реализованные оптимизации

1. **Кэш DNS:**
   - Уменьшает повторные DNS-запросы
   - Кэш с настраиваемым временем жизни
   - Автоматическая очистка кэша

2. **Управление подключениями:**
   - Повторное использование сокетов когда возможно
   - Оптимизированные таймауты
   - Умная система повторных попыток

3. **Обработка данных:**
   - Эффективный парсинг пакетов
   - Оптимизированная валидация данных
   - Эффективное управление памятью

4. **Измерение задержки:**
   - Множественные образцы для точности
   - Фильтр выбросов
   - Оптимизированный расчет средних значений

## Технические ограничения

1. **Ограничения протокола:**
   - Максимальный размер пакета: 2048 байт
   - Максимальное количество запрашиваемых игроков: 100
   - Стандартный таймаут: 1000мс

2. **Ограничения кэша:**
   - Максимальное время кэширования DNS: 5 минут
   - Лимит записей в кэше

3. **Сетевые ограничения:**
   - Максимум 3 попытки на запрос
   - Минимальный интервал между попытками: 150мс
   - Максимальный допустимый пинг: 800мс

4. **Ограничения данных:**
   - Максимальный размер строк
   - Максимальное количество правил сервера
   - Ограничения специальных символов

## Структура ответа

API возвращает подробный объект со всей информацией о сервере:

```javascript
{
    // Базовая информация
    address: "127.0.0.1", // Адрес сервера
    port: 7777, // Порт сервера
    hostname: "Server", // Название сервера
    gamemode: "RolePlay", // Режим игры
    language: "Русский", // Язык
    
    // Статус сервера
    password: false, // Защита паролем
    maxPlayers: 100, // Максимум игроков
    onlinePlayers: 45, // Игроков онлайн
    ping: 58, // Задержка в мс
    queryTime: 1635789012345, // Временная метка запроса
    
    // Список игроков
    players: [
        {
            id: 0, // ID игрока
            name: "Calasans", // Имя
            score: 63, // Очки
            ping: 117 // Пинг игрока
        },
    ],
    
    // Правила сервера
    rules: {
        allowed_clients: "0.3.7, 0.3.DL", // Разрешенные версии клиентов
        artwork: 1, // Включение artwork
        lagcomp: "On", // Статус компенсации лага
        mapname: "San Andreas", // Название карты
        version: "0.3.7", // Версия сервера
        weather: 10, // ID погоды
        weburl: "website.com", // URL сайта сервера
        worldtime: "12:00" // Время мира на сервере
    }
}
```

## Лицензия

Этот API защищен лицензией MIT, которая разрешает:
- ✔️ Коммерческое и частное использование
- ✔️ Модификацию исходного кода
- ✔️ Распространение кода
- ✔️ Сублицензирование

### Условия:

- Сохранение уведомления об авторских правах
- Включение копии лицензии MIT

Для получения дополнительной информации о лицензии: https://opensource.org/licenses/MIT